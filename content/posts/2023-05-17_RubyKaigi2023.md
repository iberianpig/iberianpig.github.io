---
layout: post
title: "RubyKaigi 2023に登壇してFusumaについて話した"
draft: false
date:    2023-05-17T09:19:06+09:00
lastmod: 2023-05-17T09:19:06+09:00
comments: true
tags: 
   - ruby
   - linux
   - libinput
image: "https://i.gyazo.com/5a7ca91b43f87ac14c3f7dfe8e38453c.png"
description: "RubyKaigi2023に登壇してDIY Your Touchpad Experience: Building Your Own GesturesというタイトルでFusumaについて話した"
---


## RubyKaigi 2023

RubyKaigi2023で登壇してFusumaについて話した。

CFP出したら通ってしまって、まだまだ先の話だと思っていたら、あっという間に当日になってしまった。

資料づくりがままならないのに途中でGem入れたほうが面白いだろうなと思ってしまったのが良くなかった。
新しくGemをこしらえてきたのだけれど、ギリギリの発表10分前に2つリリースすることになるとは思ってもみなかった。
結果fusuma本体が落ちるバグ入りプラグインをリリースをしてしまい、その後すぐに修正した。余裕を持ったスケジュールが大事。

今でも自分がRubyKaigiに登壇するなんて思ってもいなかったし、なんならもう一週間経つけれど、あんまり実感がない。
https://rubykaigi.org/2023/schedule/#day1 で並んでる面々、みんな凄い人ばかりで、自分が並んでるのが違和感があるというか、まだそんな感じがする。

### RubyKaigi is 祭

ランチブレイクの時にRubyKaigiって祭りだよねという話をしていた。
あの短い期間だけ、町がRubyistに包まれるあの熱狂的でカオスな状況、まさしく祭りだと思う。

好きなトークを聞いて、久々に会う友人・はじめましての人と話して、松本グルメ探訪し、夜はOfficial Party、Drinkup、After Party、会期中ずっとRubyの話してるのすごい楽しい。

トーク聞きに来てくれた友人の夫妻と久々に会ったらお子さんがめっちゃ大きくなってて謎に感動したり、
推しのk0kubunさんやペンさんと写真を撮ってホクホクしていたり、
初めてRubyKaigiに来たという若者見つけてバーに連れて行ったり、
特にDay 3は After Party🍺 => 居酒屋🍺 => ラーメン屋🍺 => コンビニ🍺  みたいな感じで朝までずっと飲んで話してた。
<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">ラーメン屋で朝まで飲んでた人達、みんな無事かな<a href="https://twitter.com/hashtag/rubykaigi?src=hash&amp;ref_src=twsrc%5Etfw">#rubykaigi</a> <a href="https://twitter.com/hashtag/rubyfriends?src=hash&amp;ref_src=twsrc%5Etfw">#rubyfriends</a> <a href="https://t.co/O2zDWNscAP">pic.twitter.com/O2zDWNscAP</a></p>&mdash; iberianpig(Kohei Yamada) (@nukumaro22) <a href="https://twitter.com/nukumaro22/status/1657592463379558401?ref_src=twsrc%5Etfw">May 14, 2023</a></blockquote> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
みんな体力持つなぁと思ってたんですが、多分この楽しい時間をこのRubyKaigi終わらせたくないんですよね。だからRubyKaigiの夜は長い。

ちなみに最初に参加したのはRubyKaigi 2019の福岡の時で、その時もめちゃくちゃ楽しかったけど、今回はもっと楽しめた気がする。Kaigi is back!

RubyKaigiを盛り上げてきてくださったスタッフの皆様、スポンサーしてくれている企業さんには頭が上がりません。本当にありがとうございます。


## Fusumaについて発表した

FusumaはLinuxのタッチパッド向けのマルチタッチジェスチャのツール。`gem install fusuma` でジェスチャが効くようになるツール。 ネィティブでジェスチャ実装されてないLinuxディストロでもほとんどのケースでマルチタッチジェスチャが使えるようになる。

<div class="iframely-embed"><div class="iframely-responsive" style="height: 168px; padding-bottom: 0;"><a href="https://github.com/iberianpig/fusuma" data-iframely-url="//cdn.iframe.ly/api/iframe?url=https%3A%2F%2Fgithub.com%2Fiberianpig%2Ffusuma&amp;key=f073c4f447189e73167146bd9d0f6195"></a></div></div><script async src="//cdn.iframe.ly/embed.js" charset="utf-8"></script>

初めて作ったGemなのでそれなりに思い入れがあって、また長くメンテしてると色々リファクタリングしたくなって、その結果プラグインで拡張できるようになったりしたのでその仕組みを中心に話した感じ。

Youtubeにアーカイブが上がったら見てください。

### 同時通訳

RubyKaigiは日 -> 英の同時通訳があって、自分の発表を英語に通訳してもらって日本語ネイティブじゃない方にもトークを聞いてもらえる。これめちゃくちゃすごい。

自分は通訳の方を入れて話すのは初めてだった。
当日になってギリギリまで資料を弄ってしまっていたので、事前に送った資料との差分が出ていてそのギャップを埋めるのにてんやわんやさせてしまいました。本当に申し訳ありません。

二人の通訳の方がセクション毎に交代して通訳を担当するのでお互いのパートで表現のニュアンスのズレがでないか調整をしていた。 技術通訳をされているプロの方々で、担当してくれた方はバッファやキューなどのデータ構造のことを認識されていて、その上でどの表現が適切か、発火はFireかTriggerか、みたいな細かいところまで質問していただけて、すごく新鮮な体験だった。

あと、通訳し終わる前にスライドが次に移動すると英語で聞いている人が理解しづらくなるので、話の区切りでは適宜間を持たせたほうが良いという話や、みなさんどうしても早口になるのでゆっくり落ち着いて話すようにというアドバイスをいただきました。
しかし、想定よりも若干時間が余ったのでかなりオタク特有の早口出てしまったと思います。すみません。

### 登壇資料


<iframe class="speakerdeck-iframe" frameborder="0" src="https://speakerdeck.com/player/348ac4ad084147e8a05c9c1007cb2170" title="DIY Your Touchpad Experience Building Your Own Gestures - RubyKaigi 2023" allowfullscreen="true" style="border: 0px; background: padding-box padding-box rgba(0, 0, 0, 0.1); margin: 0px; padding: 0px; border-radius: 6px; box-shadow: rgba(0, 0, 0, 0.2) 0px 5px 40px; width: 100%; height: auto; aspect-ratio: 560 / 314;" data-ratio="1.78343949044586"></iframe>

トークの中で話してた、ヨドバシに通ってMac触って挙動を確認してたのは本当で、それでエッジスワイプをプロトタイプのxSwipeに実装できた。 
Macのトラックパッド上を2本指で右端からからスワイプすると通知センター開くやつで、右端指1本分くらいの領域を通過したあとその領域にもう1回連続でタッチが入り移動するとトリガされるやつ。
ただ、Synapticsではタッチパッド上の絶対位置が取れて同じような実装が出来るのだが、相対移動しか取れないLibinputだと端を取るのがちょっと難しくまだFusumaには移植できてない。

### PluginとPipeline

Fusumaはジェスチャ認識のフローをパイプラインとしてイベントでやり取りするようになっており、その中の各タスクはプラグインとして拡張可能かつ差し替え可能になっている。
全てがプラグイン、Fluentdにかなり影響を受けている。

[![Image from Gyazo](https://i.gyazo.com/5d620bb1a58f99a1e396abf3157684a6.png)](https://gyazo.com/5d620bb1a58f99a1e396abf3157684a6)

後半にOne more thing的なノリで新しいプラグインを発表した。

### ThumbSense

ThumbSenseはSony CSLの暦本先生の2003年の[論文](https://www2.sonycsl.co.jp/person/rekimoto/papers/chi03tsense.pdf)とその実装で、オリジナルはWindows向けのソフトウェア。
これをFusumaのPluginとして実装した。

[![Image from Gyazo](https://i.gyazo.com/f5595089b529ad8ddd93777604d9c6be.jpg)](https://gyazo.com/f5595089b529ad8ddd93777604d9c6be)

タッチパッドが追加の修飾キーになるようなイメージ。親指でタッチパッドに触れる間JやFのキーがクリックにリマップされる。
タッチを検知してキーボードレイヤの変更を依頼する[fusuma-plugin-thumbsense](https://github.com/iberianpig/fusuma-plugin-thumbsense)
と、外部プロセスから動的にレイヤ変更できるキーリマッパーの[fusuma-plugin-remap](https://github.com/iberianpig/fusuma-plugin-remap)の2つのGemで実現している。

[![Image from Gyazo](https://i.gyazo.com/cf929775aec1e3aefaabb3a6dd15a3ff.gif)](https://gyazo.com/cf929775aec1e3aefaabb3a6dd15a3ff)

実は親指を使わなくても便利で、ThumbSenseの状態でFを押しっぱなしにした場合、ドラッグ中はタッチパッドから手が離れても問題ないように実装している。つまりこの間タッチパッドを自由にスクロールしたりスワイプしたりできる。

[![Image from Gyazo](https://i.gyazo.com/b434e5c33712b210ea58650451c21caf.gif)](https://gyazo.com/b434e5c33712b210ea58650451c21caf)
ドラッグ中に別のワークスペースにスワイプして移動してドロップ、 ThumbSenseが出た当時はスワイプジェスチャは無かったはずだけど、この組み合わせはすごく便利。 みんなLinuxにしてFusuma使ってみよう。

あとタップしてクリックする機能がオフに出来るのでキーボード入力中にタッチパッド触って誤操作することが無くなって便利だった。

### 今後の展望

ThumbSenseは自分の中でかなり良い環境改善になった。
これからしばらくThumbsenseの使い勝手とキーリマッパーとしての拡張性を向上させていきたい。

あとPalm Detectionが微妙なのでなんとかしたい気持ちもあるし、そもそもFusumaのinputプラグインはLibinputをFFI経由で使えるようにしたい、色々やりたいことがある。



## RubyKaigiの後

しばらく余韻が抜けてなくて、いやー、楽しかったなと思い出している。
次のRubyKaigiは沖縄、めちゃくちゃ楽しみ。MINASWAN、また沖縄で会いましょう！


それと、RubyKaigi後お仕事の話を色々と頂けており嬉しい限りです。ありがとうございます。

[PR]法人としてRubyのお仕事お請けしております。よろしくおねがいします。:pray:


